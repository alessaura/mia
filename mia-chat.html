<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Mia - Banco Nova Era</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #f5f7fb;
        --card: #ffffff;
        --accent: #4b7bec;
        --accent-soft: #e3ecff;
        --text: #222222;
        --muted: #6b7280;
        --radius-lg: 18px;
        --radius-pill: 999px;
        --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        background: radial-gradient(circle at top, #e0ecff, #f5f7fb 55%);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }

      .app {
        width: 100%;
        max-width: 420px;
      }

      .card {
        background: var(--card);
        border-radius: 24px;
        box-shadow: var(--shadow-soft);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: min(620px, 90vh);
      }

      .header {
        padding: 16px 18px;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid #e5e7eb;
        background: linear-gradient(
          135deg,
          #f9fbff 0%,
          #f3f6ff 40%,
          #fef9ff 100%
        );
      }

      .avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 20%, #ffffff, #dbe6ff);
        border: 2px solid #e0e7ff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: var(--accent);
      }

      .header-text {
        display: flex;
        flex-direction: column;
      }

      .header-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text);
      }

      .header-sub {
        font-size: 12px;
        color: var(--muted);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.18);
        margin-left: auto;
      }

      .chat {
        flex: 1;
        padding: 16px 14px;
        overflow-y: auto;
        background: linear-gradient(
          180deg,
          #f7f8fc 0%,
          #f9fafb 60%,
          #fdfefe 100%
        );
      }

      .hint {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 10px;
        text-align: center;
      }

      .bubble-row {
        display: flex;
        margin-bottom: 10px;
      }

      .bubble-row.bot {
        justify-content: flex-start;
      }

      .bubble-row.user {
        justify-content: flex-end;
      }

      .bubble {
        max-width: 80%;
        padding: 10px 12px;
        border-radius: 14px;
        font-size: 13px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .bubble.bot {
        background: #ffffff;
        border-radius: 16px 16px 16px 6px;
        border: 1px solid #e5e7eb;
        color: var(--text);
      }

      .bubble.user {
        background: var(--accent);
        border-radius: 16px 16px 6px 16px;
        color: #ffffff;
      }

      .bubble.system {
        background: var(--accent-soft);
        color: var(--muted);
        border-radius: 999px;
        margin: 0 auto 12px;
        font-size: 11px;
      }

      .footer {
        padding: 10px 12px 12px;
        border-top: 1px solid #e5e7eb;
        background: #ffffff;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .input-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .input {
        flex: 1;
        border-radius: var(--radius-pill);
        border: 1px solid #e5e7eb;
        padding: 9px 12px;
        font-size: 13px;
        outline: none;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }

      .input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(75, 126, 236, 0.12);
      }

      .button {
        border-radius: var(--radius-pill);
        border: none;
        padding: 9px 14px;
        font-size: 13px;
        font-weight: 600;
        background: var(--accent);
        color: #ffffff;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: transform 0.08s ease, box-shadow 0.12s ease,
          background 0.15s ease;
        box-shadow: 0 8px 18px rgba(75, 126, 236, 0.35);
      }

      .button:active {
        transform: translateY(1px);
        box-shadow: 0 4px 10px rgba(75, 126, 236, 0.28);
      }

      .button.secondary {
        background: #eef2ff;
        color: #4b5563;
        box-shadow: none;
        font-size: 11px;
        padding: 6px 10px;
        align-self: center;
      }

      .button.secondary:active {
        transform: translateY(0);
        box-shadow: none;
      }

      .meta {
        font-size: 10px;
        color: var(--muted);
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <div class="header">
          <div class="avatar">M</div>
          <div class="header-text">
            <div class="header-title">Mia ‚Ä¢ Banco Nova Era</div>
            <div class="header-sub">Assistente virtual de valida√ß√£o</div>
          </div>
          <div class="status-dot"></div>
        </div>

        <div id="chat" class="chat">
          <div class="bubble bubble-system">
            Essa √© uma simula√ß√£o da Mia usando a sua API local.
          </div>
        </div>

        <div class="footer">
          <div class="input-row">
            <input
              id="messageInput"
              class="input"
              type="text"
              placeholder="Digite sua mensagem..."
            />
            <button id="sendButton" class="button">
              Enviar
              <span>‚û§</span>
            </button>
          </div>
          <button id="startButton" class="button secondary">
            Iniciar conversa com a Mia
          </button>
          <div class="meta">
            Conectado em: <code>http://localhost:3000/api/v1/conversation/message</code>
          </div>
        </div>
      </div>
    </div>

    <script>
      const chatEl = document.getElementById('chat');
      const inputEl = document.getElementById('messageInput');
      const sendButton = document.getElementById('sendButton');
      const startButton = document.getElementById('startButton');

      const CUSTOMER_ID = 'cust-empresa1';
      const API_URL = 'http://localhost:3000/api/v1/conversation/message';

      let sessionId = null;
      let isStarting = false;

      function appendBubble(text, type = 'bot') {
        const row = document.createElement('div');
        row.className = 'bubble-row ' + type;

        const bubble = document.createElement('div');
        bubble.className = 'bubble ' + type;
        bubble.textContent = text;

        row.appendChild(bubble);
        chatEl.appendChild(row);
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      async function startConversation() {
        if (isStarting) return;
        isStarting = true;
        startButton.disabled = true;

        try {
          // primeira chamada: s√≥ customerId, sem mensagem
          const res = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              customerId: CUSTOMER_ID,
            }),
          });

          const data = await res.json();

          if (!res.ok || !data.success) {
            appendBubble('Erro ao iniciar conversa com a Mia.', 'bot');
            console.error('Start error:', data);
            return;
          }

          sessionId = data.sessionId;
          appendBubble(data.response, 'bot');
        } catch (err) {
          console.error(err);
          appendBubble('N√£o consegui falar com a API da Mia. üò¢', 'bot');
        } finally {
          isStarting = false;
          startButton.disabled = false;
        }
      }

      async function sendMessage() {
        const text = inputEl.value.trim();
        if (!text) return;

        appendBubble(text, 'user');
        inputEl.value = '';

        try {
          const payload = sessionId
            ? {
                sessionId,
                message: text,
              }
            : {
                customerId: CUSTOMER_ID,
                message: text,
              };

          const res = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          const data = await res.json();

          if (!res.ok || !data.success) {
            appendBubble('Erro ao processar a mensagem. üòï', 'bot');
            console.error('API error:', data);
            return;
          }

          if (data.sessionId) {
            sessionId = data.sessionId;
          }

          if (data.response) {
            appendBubble(data.response, 'bot');
          }
        } catch (err) {
          console.error(err);
          appendBubble(
            'Tive um problema t√©cnico ao falar com o servidor da Mia. üòî',
            'bot'
          );
        }
      }

      // Eventos
      startButton.addEventListener('click', startConversation);
      sendButton.addEventListener('click', sendMessage);

      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendMessage();
        }
      });
    </script>
  </body>
</html>
